#Область ОбработчикиСобытийФормы 

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Настройки = БонусыВызовСервера.ПолучитьЗначенияНастроек();
	
	ЭтотОбъект.Элементы.ГруппаСМС.Видимость = Настройки.ИдентификацияПриНачислении;
	ЭтотОбъект.Элементы.НачислитьБонусы.Доступность = НЕ Настройки.ИдентификацияПриНачислении;

КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если НЕ Параметры.Свойство("ДокументСсылка") Тогда
		
		БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Эту форму можно открыть только из документа'"));
		Отказ = Истина;
		Возврат;
		
	КонецЕсли;
	
	ДокументСсылка    = Параметры.ДокументСсылка;
	Партнер           = Параметры.Партнер;
	БонусыКНачислению = Параметры.БонусыКНачислению;
		
	ДоступныеБонусы = БонусыВызовСервера.ПолучитьДоступныеБонусы(Партнер); 
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаСервере
Процедура ОтправитьКодНаСервере()
	
	Телефон = БонусыВызовСервера.ПолучитьНомерТелефонаПартнера(Партнер);
	Если ПустаяСтрока(Телефон) Тогда
		БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'У покупателя не указан номер телефона'"));
		Возврат;
	КонецЕсли;
	
	ГСЧ = Новый ГенераторСлучайныхЧисел();
	КодПодтверждения = Формат(ГСЧ.СлучайноеЧисло(1000, 9999), "ЧГ=0");
	ЭтотОбъект.КодПодтверждения = КодПодтверждения; // сохраняем код в реквизите формы
	
	Текст = "Код подтверждения: " + КодПодтверждения;
	
	Успешно = БонусыВызовСервера.ОтправитьСМСКод(Телефон, Текст);
	
	Если Успешно Тогда
		БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Код отправлен'"));
	Иначе
		БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Не удалось отправить код'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьКод(Команда)
	ОтправитьКодНаСервере();
КонецПроцедуры

&НаСервере
Функция ПроверитьКодНаСервере()
    Если ПустаяСтрока(ЭтотОбъект.КодПодтверждения) Тогда
        БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Код подтверждения не был отправлен'"));
        Возврат Ложь;
    КонецЕсли;
    
    Если ЭтотОбъект.КодИзСМС = ЭтотОбъект.КодПодтверждения Тогда
        БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Код подтверждён'"));
        Возврат Истина;
    Иначе
        БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Неверный код. Проверьте и попробуйте ещё раз'"));
        Возврат Ложь;
    КонецЕсли;
КонецФункции

&НаКлиенте
Процедура ПроверитьКод(Команда)
	Результат = ПроверитьКодНаСервере();
    ЭтотОбъект.Элементы.НачислитьБонусы.Доступность = Результат;
КонецПроцедуры

&НаКлиенте
Процедура НачислитьБонусы(Команда)
	
	Если НЕ ЗначениеЗаполнено(БонусыКНачислению) Тогда
		БонусыВызовСервера.СообщитьПользователю(НСтр("ru = 'Укажите сумму бонусов для начисления'"));
		Возврат;
	КонецЕсли; 
	
	Сообщение = БонусыВызовСервера.НачислитьБонусы(ДокументСсылка, БонусыКНачислению);

	Оповещение = Новый ОписаниеОповещения("ПослеСообщенияБонусыНачислены", ЭтотОбъект);
	ПоказатьПредупреждение(Оповещение, Сообщение.Текст, 0, "Начисление бонусов");
	
КонецПроцедуры 

&НаКлиенте
Процедура ПослеСообщенияБонусыНачислены(Знач Параметр) Экспорт
	Закрыть();
КонецПроцедуры

#КонецОбласти
