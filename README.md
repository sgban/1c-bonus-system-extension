## Инструкция по работе с бонусной системой

### 1. Права доступа
Для работы с бонусами пользователь должен входить в группу доступа **«Управление бонусами»**.

**Добавление пользователя в группу:**
1. Раздел **НСИ и администрирование → Настройки пользователей и прав → Группы доступа**
2. Выбрать группу **«Управление бонусами»**
3. Нажать **Подобрать** и отметить пользователей
4. Сохранить изменения

---

### 2. Участие клиента в бонусной программе
Операции с бонусами доступны только для клиентов с установленным флагом  
**«Участвует в бонусной программе»**.

**Как включить:**
1. Открыть карточку клиента
2. Вкладка **Дополнительно**
3. Установить флажок **Участвует в бонусной программе**
4. Сохранить изменения

⚠️ Если флаг не установлен:
- кнопка **«Бонусы»** в документах не отображается
- начисление и списание бонусов недоступны

---

### 3. Расчет бонусов
- Бонусы рассчитываются по документу **Реализация товаров и услуг**
- Расчет выполняется автоматически при заполнении табличной части
- Результат отображается в реквизите **«Сумма бонусов к начислению»**

**Формула расчета:**
Бонус = Цена РРЦ – Цена Розница


- Используются цены, актуальные на дату документа
- Возможны индивидуальные настройки видов цен для клиента

---

### 4. Начисление бонусов
Для начисления бонусов выберите пункт **«Начислить»** в меню кнопки **«Бонусы»**.

**Условия:**
- Документ записан
- Клиент заполнен
- По документу ранее не выполнялось начисление

**Процесс:**
- Открывается форма начисления
- Отображается сумма к начислению (доступна для ручного изменения)
- После подтверждения бонусы зачисляются на бонусный счет клиента
- Пользователь получает сообщение о результате

---

### 5. Списание бонусов
Для списания выберите пункт **«Списать»** в меню кнопки **«Бонусы»**.

**Проверки:**
- Повторное списание по одному документу невозможно
- Сумма списания не превышает доступные бонусы

**Ограничения:**
Макс. списание = СуммаДокумента × ПроцентОграничения / 100

(и не больше остатка бонусов клиента)

После подтверждения:
- сумма списания распределяется как скидка по строкам табличной части
- итоговая сумма документа уменьшается (включая НДС)

---

### 6. Срок доступности бонусов
Каждая партия начисленных бонусов становится доступной **через 20 календарных дней**
после даты документа начисления.

**Пример:**
- 01.07 — начислено 10 бонусов → доступны с 21.07
- 02.07 — начислено 15 бонусов → доступны с 22.07

До истечения срока бонусы недоступны для списания.

---

### 7. Подтверждение операций SMS-кодом
Начисление и списание бонусов могут подтверждаться **SMS-кодом**.

- Идентификация включается/отключается отдельно для начисления и списания
- Код отправляется на номер телефона клиента

**Порядок:**
1. Нажать **Отправить код**
2. Ввести полученный 4-значный код
3. Нажать **Проверить код**
4. При успешной проверке становится доступна кнопка подтверждения операции

---

### 8. Отчет по бонусам
Для контроля используется отчет **БонусыПокупателей**.

Отображает:
- начисленные
- списанные
- доступные бонусы
- остаток

**Поля отчета:**
- Покупатель
- Начислено
- Списано
- Доступно
- Остаток
- Документ

---

### 9. Настройки бонусной системы
Форма **«Настройки бонусов»** открывается из меню кнопки **«Бонусы» → Настроить**.

**Общие настройки:**
- API ID сервиса sms.ru
- Процент ограничения списания бонусов
- Использование SMS-идентификации

**Индивидуальные настройки:**
- Для клиента можно задать собственную формулу расчета бонусов
- При отсутствии индивидуальных настроек используются значения по умолчанию

---

### 10. Исключения из расчета бонусов
Строка не участвует в расчете, если:
- отсутствует цена по одному из видов цен
- результат расчета меньше нуля

---

### 11. Автоматическое начисление бонусов
Начисление выполняется регламентным заданием  
**НачислениеБонусов**.

**Параметры по умолчанию:**
- Периодичность: ежедневно
- Время: 02:00–06:00

**Периоды начисления:**
- Первый запуск: с 07.07.2025 по текущую дату
- Далее: с даты последнего запуска по текущую дату

Рекомендуется выполнять задание в ночное время.
